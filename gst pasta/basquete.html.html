<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Tiger vs Bear</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    canvas { display: block; }

    #menuInicial, #telaVitoria {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: orange;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #000;
      user-select: none;
      z-index: 9999;
    }
    #menuInicial img, #telaVitoria img {
      width: 300px;
      height: auto;
      margin-bottom: 20px;
      image-rendering: pixelated;
      border: 3px solid black;
    }

    /* Fonte Bangers para títulos */
    #menuInicial h1, #telaVitoria h1, #mensagemVitoria {
      font-family: 'Bangers', cursive;
      font-weight: normal;
    }
    #menuInicial h1 {
      font-size: 4vw;
      margin-bottom: 40px;
      text-shadow: 2px 2px 4px #444;
    }
    #telaVitoria h1 {
      font-size: 5vw;
      color: #ffd700;
      text-shadow: 3px 3px 6px #000;
      margin-bottom: 40px;
    }
    #botaoJogar, #botaoReiniciar {
      font-size: 2.5vw;
      padding: 15px 40px;
      background: #ffd700;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 6px #888;
      transition: background 0.3s ease;
      font-family: 'Bangers', cursive;
    }
    #botaoJogar:hover, #botaoReiniciar:hover {
      background: #ffea00;
    }
    
    #telaVitoria {
      display: none;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>

  <div id="menuInicial">
    <img src="tigre-vs-urso.png" alt="Tiger vs Bear Logo" />
    <h1>Tiger vs Bear</h1>
    <button id="botaoJogar">Jogar</button>
  </div>
  
  <div id="telaVitoria">
    <img id="vencedorImagem" src="" alt="Vencedor" />
    <h1 id="mensagemVitoria"></h1>
    <button id="botaoReiniciar">Jogar Novamente</button>
  </div>

<script>
let jogadores = [];
let bola;
let gravidade;
let alturaDoChao;
let raioDaBola;
let teclas = {};
let placar = [0, 0];
let tamanhoDoJogador;
let puloDoJogador;
let velocidadeDoJogador;
let alturaDaCesta;
let larguraDaCesta;
let espessuraDaCesta;

let bolaNaAreaCestaEsq = false;
let bolaNaAreaCestaDir = false;

let jogoIniciado = false;
let jogoAcabou = false;
let tigerSprite;
let bearSprite;
let tigerWalkRightSprite;
let bearWalkRightSprite;

function preload() {
  tigerSprite = loadImage("tiger_idle.png");
  bearSprite = loadImage("bear_idle.png");
  tigerWalkRightSprite = loadImage("tiger_walk.png");
  bearWalkRightSprite = loadImage("bear_walk.png");
}

function setup() {
  createCanvas(windowWidth, windowHeight);
  recalcularMedidas();

  // ❌ REMOVIDO: noLoop() → para o draw não parar
  inicializarJogo();

  // Evento do botão Jogar
  document.getElementById('botaoJogar').addEventListener('click', () => {
    jogoIniciado = true;
    document.getElementById('menuInicial').style.display = 'none';
    // Não precisa de loop() porque já está rodando
  });

  // Evento do botão Reiniciar
  document.getElementById('botaoReiniciar').addEventListener('click', () => {
    jogoAcabou = false;
    placar = [0, 0];
    document.getElementById('telaVitoria').style.display = 'none';
    inicializarJogo();
  });
}

function inicializarJogo() {
  jogadores = [];
  jogadores.push(new Jogador(width * 0.1, alturaDoChao, color(255, 100, 100), "W", "A", "D"));
  jogadores.push(new Jogador(width * 0.9, alturaDoChao, color(100, 100, 255), "ArrowUp", "ArrowLeft", "ArrowRight"));

  bola = new Bola(width / 2, alturaDoChao - raioDaBola * 5);
}

function recalcularMedidas() {
  gravidade = height * 0.005;
  raioDaBola = height * 0.03;
  tamanhoDoJogador = height * 0.12;
  puloDoJogador = height * 0.08;
  velocidadeDoJogador = width * 0.01;
  alturaDoChao = height * 0.85;
  alturaDaCesta = height * 0.25;
  larguraDaCesta = width * 0.02;
  espessuraDaCesta = height * 0.13;
}

function draw() {
  background(100, 200, 100);

  // Desenha o chão
  fill(70, 50, 20);
  rect(0, alturaDoChao, width, height - alturaDoChao);

  if (!jogoIniciado || jogoAcabou) {
    // Só desenha fundo e chão, mas não os jogadores nem bola
    return;
  }

  // Desenha as cestas
  fill(255, 255, 0, 150);
  rect(larguraDaCesta, alturaDaCesta + espessuraDaCesta - larguraDaCesta, espessuraDaCesta - larguraDaCesta * 2, larguraDaCesta);
  rect(width - espessuraDaCesta + larguraDaCesta, alturaDaCesta + espessuraDaCesta - larguraDaCesta, espessuraDaCesta - larguraDaCesta * 2, larguraDaCesta);

  fill(139, 69, 19);
  rect(0, alturaDaCesta, larguraDaCesta, espessuraDaCesta);
  rect(espessuraDaCesta - larguraDaCesta, alturaDaCesta, larguraDaCesta, espessuraDaCesta);
  rect(0, alturaDaCesta + espessuraDaCesta - larguraDaCesta, espessuraDaCesta, larguraDaCesta);
  rect(width - espessuraDaCesta, alturaDaCesta, larguraDaCesta, espessuraDaCesta);
  rect(width - larguraDaCesta, alturaDaCesta, larguraDaCesta, espessuraDaCesta);
  rect(width - espessuraDaCesta, alturaDaCesta + espessuraDaCesta - larguraDaCesta, espessuraDaCesta, larguraDaCesta);

  // Placar
  fill(0);
  textFont('Bangers');
  textSize(height * 0.04);
  textAlign(CENTER, TOP);
  text(`${placar[0]}   |   ${placar[1]}`, width / 2, 10);

  // Atualiza e mostra jogadores
  for (let j of jogadores) {
    j.atualizar();
    j.mostrar();
  }

  // Bola
  bola.atualizar();
  bola.verificarColisao();
  bola.mostrar();

  verificarPlacar();

  // Colisão entre jogadores
  for (let i = 0; i < jogadores.length; i++) {
    for (let j = i + 1; j < jogadores.length; j++) {
      let a = jogadores[i];
      let b = jogadores[j];
      let dx = b.x - a.x;
      let dy = b.y - a.y;
      let distAB = dist(a.x, a.y, b.x, b.y);
      let minDist = a.raio + b.raio;

      if (distAB < minDist) {
        let overlap = (minDist - distAB) / 2;
        let angle = atan2(dy, dx);
        let offsetX = cos(angle) * overlap;
        let offsetY = sin(angle) * overlap;

        a.x -= offsetX;
        a.y -= offsetY;
        b.x += offsetX;
        b.y += offsetY;
      }
    }
  }

  // Colisão jogador com bola
  for (let j of jogadores) {
    let dx = bola.x - j.x;
    let dy = bola.y - j.y;
    let distancia = dist(j.x, j.y, bola.x, bola.y);
    let distanciaMinima = j.raio + raioDaBola;

    if (distancia < distanciaMinima) {
      let sobreposicao = distanciaMinima - distancia;
      let angulo = atan2(dy, dx);
      let offsetX = cos(angulo) * sobreposicao;
      let offsetY = sin(angulo) * sobreposicao;

      j.x -= offsetX * 0.5;
      j.y -= offsetY * 0.5;
      bola.x += offsetX * 0.5;
      bola.y += offsetY * 0.5;

      bola.vx += cos(angulo) * 0.5;
      bola.vy += sin(angulo) * 0.5;
    }
  }
}

function verificarPlacar() {
  if (placar[0] >= 2 || placar[1] >= 2) {
    fimDeJogo();
    return;
  }

  const aberturaEsqMinX = larguraDaCesta;
  const aberturaEsqMaxX = espessuraDaCesta - larguraDaCesta;
  const aberturaEsqY = alturaDaCesta + espessuraDaCesta - larguraDaCesta;

  const aberturaDirMinX = width - espessuraDaCesta + larguraDaCesta;
  const aberturaDirMaxX = width - larguraDaCesta;
  const aberturaDirY = alturaDaCesta + espessuraDaCesta - larguraDaCesta;

  // Cesta esquerda (ponto para jogador 1)
  if (bola.x > aberturaEsqMinX && bola.x < aberturaEsqMaxX && bola.y > alturaDaCesta && bola.y < aberturaEsqY) {
    bolaNaAreaCestaEsq = true;
  }
  if (bolaNaAreaCestaEsq && bola.y > aberturaEsqY) {
    placar[1]++;
    reiniciarJogo();
    bolaNaAreaCestaEsq = false;
  }

  // Cesta direita (ponto para jogador 0)
  if (bola.x > aberturaDirMinX && bola.x < aberturaDirMaxX && bola.y > alturaDaCesta && bola.y < aberturaDirY) {
    bolaNaAreaCestaDir = true;
  }
  if (bolaNaAreaCestaDir && bola.y > aberturaDirY) {
    placar[0]++;
    reiniciarJogo();
    bolaNaAreaCestaDir = false;
  }
}

function fimDeJogo() {
  jogoAcabou = true;
  noLoop(); // Opcional: para o jogo após vitória

  let vencedor = placar[0] >= 2 ? 0 : 1;
  let mensagem = vencedor === 0 ? "Quer melzinho, meu felpudinho?" : "Volta pro seu Sucrilhos, gatinho!";
  let imagemVencedor = vencedor === 0 
    ? "8073c123-d260-458a-9b18-62bbaf493799.png"
    : "0c096d75-74bc-49e4-800a-f38af04a232d.png";

  document.getElementById('mensagemVitoria').textContent = mensagem;
  document.getElementById('vencedorImagem').src = imagemVencedor;
  document.getElementById('telaVitoria').style.display = 'flex';
}

function reiniciarJogo() {
  bola = new Bola(width / 2, alturaDoChao - raioDaBola * 5);
  jogadores[0].x = width * 0.1;
  jogadores[0].y = alturaDoChao;
  jogadores[1].x = width * 0.9;
  jogadores[1].y = alturaDoChao;
}

class Jogador {
  constructor(x, y, cor, teclaCima, teclaEsquerda, teclaDireita) {
    this.x = x;
    this.y = y;
    this.raio = tamanhoDoJogador * 0.5;
    this.alturaSprite = tamanhoDoJogador * 1.5;
    this.vx = 0;
    this.vy = 0;
    this.cor = cor;
    this.noChao = true;
    this.teclaCima = teclaCima.toUpperCase();
    this.teclaEsquerda = teclaEsquerda.toUpperCase();
    this.teclaDireita = teclaDireita.toUpperCase();
    this.direction = 1;
    this.isTiger = cor.toString() === color(255, 100, 100).toString();
  }

  atualizar() {
    this.vy += gravidade;
    this.y += this.vy;

    if (teclas[this.teclaEsquerda]) {
      this.x -= velocidadeDoJogador;
      this.direction = -1;
    }
    if (teclas[this.teclaDireita]) {
      this.x += velocidadeDoJogador;
      this.direction = 1;
    }

    if (this.y + this.raio >= alturaDoChao) {
      this.y = alturaDoChao - this.raio;
      this.vy = 0;
      this.noChao = true;
    }

    this.x = constrain(this.x, this.raio, width - this.raio);
  }

  mostrar() {
    let spriteTopY = this.y + this.raio - this.alturaSprite;
    let ajusteIdle = 5;
    let ajusteWalk = 10;

    spriteTopY += (teclas[this.teclaEsquerda] || teclas[this.teclaDireita]) ? ajusteWalk : ajusteIdle;

    push();
    translate(this.x, spriteTopY);
    scale(this.direction, 1);
    imageMode(CORNER);

    let spriteWidth = this.raio * 2;
    let spriteHeight = this.alturaSprite;

    if (this.isTiger) {
      image(teclas[this.teclaEsquerda] || teclas[this.teclaDireita] ? tigerWalkRightSprite : tigerSprite, 0, 0, spriteWidth, spriteHeight);
    } else {
      image(teclas[this.teclaEsquerda] || teclas[this.teclaDireita] ? bearWalkRightSprite : bearSprite, 0, 0, spriteWidth, spriteHeight);
    }
    pop();
  }
}

class Bola {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.vx = random([-1, 1]) * velocidadeDoJogador * 0.01;
    this.vy = 0;
  }

  atualizar() {
    this.vy += gravidade;
    this.x += this.vx;
    this.y += this.vy;

    if (this.y + raioDaBola > alturaDoChao) {
      this.y = alturaDoChao - raioDaBola;
      this.vy *= -0.75;
    }

    if (this.x - raioDaBola < 0) {
      this.x = raioDaBola;
      this.vx *= -0.8;
    }
    if (this.x + raioDaBola > width) {
      this.x = width - raioDaBola;
      this.vx *= -0.8;
    }

    if (this.y - raioDaBola < 0) {
      this.y = raioDaBola;
      this.vy *= -0.6;
    }
  }

  verificarColisao() {
    for (let j of jogadores) {
      let d = dist(this.x, this.y, j.x, j.y);
      if (d < raioDaBola + j.raio) {
        if (!j.noChao) {
          this.vy = -puloDoJogador * 0.5;
          this.vx = j.x < this.x ? velocidadeDoJogador * 0.3 : -velocidadeDoJogador * 0.3;
        } else {
          let angulo = atan2(this.y - j.y, this.x - j.x);
          this.vx = cos(angulo) * velocidadeDoJogador * 0.15;
          this.vy = sin(angulo) * -puloDoJogador * 0.7;
        }
      }
    }
  }

  mostrar() {
    fill(255);
    noStroke();
    ellipse(this.x, this.y, raioDaBola * 2);
  }
}

function keyPressed() {
  if (!jogoIniciado || jogoAcabou) return;
  teclas[key.toUpperCase()] = true;

  for (let j of jogadores) {
    if (key.toUpperCase() === j.teclaCima && j.noChao) {
      j.vy = -puloDoJogador;
      j.noChao = false;

      let d = dist(j.x, j.y, bola.x, bola.y);
      if (d < j.raio + raioDaBola * 1.5) {
        bola.vy = -puloDoJogador * 1.0;
        bola.vx += j.x < bola.x ? velocidadeDoJogador * 1.2 : -velocidadeDoJogador * 1.2;
      }
    }
  }
}

function keyReleased() {
  teclas[key.toUpperCase()] = false;
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  recalcularMedidas();
  if (jogoIniciado) {
    inicializarJogo();
  }
}
</script>
</body>
</html>