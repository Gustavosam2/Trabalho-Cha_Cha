<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Tiger vs Bear</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
    canvas { display: block; }

    #telaVitoria {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #telaVitoria img {
      width: 300px;
      height: auto;
      margin-bottom: 20px;
      image-rendering: pixelated;
      border: 3px solid black;
    }
    #telaVitoria h1 {
      font-family: 'Bangers', cursive;
      font-size: 5vw;
      color: #ffd700;
      text-shadow: 3px 3px 6px #000;
      margin-bottom: 40px;
    }
    #botaoReiniciar {
      font-size: 2.5vw;
      padding: 15px 40px;
      background: #ffd700;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 2px 2px 6px #888;
      transition: background 0.3s ease;
      font-family: 'Bangers', cursive;
    }
    #botaoReiniciar:hover {
      background: #ffea00;
    }
  </style>
</head>
<body>
  <div id="telaVitoria">
    <img id="vencedorImagem" src="" alt="Vencedor" />
    <h1 id="mensagemVitoria"></h1>
    <button id="botaoReiniciar" onclick="window.location.href='basquete.html'">Jogar Novamente</button>
  </div>

  <script>
    /* ==========================
       Vari√°veis principais
       ========================== */
    let jogadores = [];
    let bola;
    let gravidade;
    let alturaDoChao;
    let raioDaBola;
    let teclas = {};
    let placar = [0, 0];
    let tamanhoDoJogador;
    let puloDoJogador;
    let velocidadeDoJogador;
    let alturaDaCesta;
    let larguraDaCesta;
    let espessuraDaCesta;

    let bolaNaAreaCestaEsq = false;
    let bolaNaAreaCestaDir = false;
    let jogoIniciado = true;
    let jogoAcabou = false;

    /* Sprites */
    let tigerSprite, tigerWalkRightSprite, tigerJumpSprite, tigerPushSprite;
    let bearSprite, bearWalkRightSprite, bearJumpSprite, bearPushSprite;
    let chaoEcestas, fundoPlateiaCestas;
    let bolaSprite;

    /* Cooldown do empurr√£o */
    let podeEmpurrarTiger = true;
    let podeEmpurrarBear = true;

    /* Controle de anima√ß√£o de empurr√£o */
    let tigerEmpurrando = false;
    let bearEmpurrando = false;
    let tempoEmpurrando = 0;

    /* ==========================
       Preload
       ========================== */
    function preload() {
      tigerSprite = loadImage("tiger_idle.png");
      tigerWalkRightSprite = loadImage("tiger_walk.png");
      tigerJumpSprite = loadImage("tiger_jump.png");
      tigerPushSprite = loadImage("tiger_push.png");

      bearSprite = loadImage("bear_idle.png");
      bearWalkRightSprite = loadImage("bear_walk.png");
      bearJumpSprite = loadImage("bear_jump.png");
      bearPushSprite = loadImage("bear_push.png");

      chaoEcestas = loadImage("chaoEcestas.png");
      fundoPlateiaCestas = loadImage("fundoPlateiaCestas.png");
      bolaSprite = loadImage("bola_basquete.png");
    }

    /* ==========================
       Setup
       ========================== */
    function setup() {
      createCanvas(windowWidth, windowHeight);
      recalcularMedidas();
      inicializarJogo();
    }

    function recalcularMedidas() {
      gravidade = height * 0.0055;
      raioDaBola = height * 0.05;
      tamanhoDoJogador = height * 0.18;
      puloDoJogador = height * 0.075;
      velocidadeDoJogador = width * 0.012;
      alturaDoChao = height * 0.85;
      alturaDaCesta = height * 0.25;
      larguraDaCesta = width * 0.02;
      espessuraDaCesta = height * 0.13;
    }

    function inicializarJogo() {
      jogadores = [];
      jogadores.push(new Jogador(width * 0.1, alturaDoChao, color(255, 100, 100), "W", "A", "D"));
      jogadores.push(new Jogador(width * 0.9, alturaDoChao, color(100, 100, 255), "ArrowUp", "ArrowLeft", "ArrowRight"));
      bola = new Bola(width / 2);
      podeEmpurrarTiger = true;
      podeEmpurrarBear = true;
      tigerEmpurrando = false;
      bearEmpurrando = false;
    }

    /* ==========================
       Draw
       ========================== */
    function draw() {
      image(chaoEcestas, 0, alturaDoChao, width, height - alturaDoChao);
      image(fundoPlateiaCestas, 0, 0, width, alturaDoChao);

      if (!jogoIniciado || jogoAcabou) return;

      // Placar
      fill(0);
      textFont('Bangers');
      textSize(height * 0.04);
      textAlign(CENTER, TOP);
      text(`${placar[0]}   |   ${placar[1]}`, width / 2, 10);

      // Instru√ß√µes
      fill(255);
      textSize(16);
      textAlign(LEFT, TOP);
      text("Tiger: W pula | J empurra", 20, 20);
      text("Bear: ‚Üë pula | 0 empurra", 20, 50);

      if (!podeEmpurrarTiger) {
        fill(255, 200, 0);
        text("J (cooldown)", 20, 80);
      }
      if (!podeEmpurrarBear) {
        fill(255, 200, 0);
        text("0 (cooldown)", 20, 100);
      }

      // Atualiza jogadores
      for (let j of jogadores) {
        j.atualizar();
        j.mostrar();
      }

      bola.atualizar();
      bola.verificarColisao();
      bola.mostrar();
      verificarPlacar();

      // Colis√£o entre jogadores
      for (let i = 0; i < jogadores.length; i++) {
        for (let k = i + 1; k < jogadores.length; k++) {
          let a = jogadores[i];
          let b = jogadores[k];
          let dx = b.x - a.x;
          let dy = b.y - a.y;
          let distAB = dist(a.x, a.y, b.x, b.y);
          let minDist = a.raio + b.raio;

          if (distAB < minDist) {
            let overlap = (minDist - distAB) / 2;
            let angle = atan2(dy, dx);
            let offsetX = cos(angle) * overlap;
            let offsetY = sin(angle) * overlap;
            a.x -= offsetX;
            a.y -= offsetY;
            b.x += offsetX;
            b.y += offsetY;
          }
        }
      }

      // Controla dura√ß√£o do sprite de empurr√£o
      if (tigerEmpurrando && millis() > tempoEmpurrando) {
        tigerEmpurrando = false;
      }
      if (bearEmpurrando && millis() > tempoEmpurrando) {
        bearEmpurrando = false;
      }
    }

    /* ==========================
       Classe Jogador
       ========================== */
    class Jogador {
      constructor(x, peNoChaoY, cor, teclaCima, teclaEsquerda, teclaDireita) {
        this.raio = tamanhoDoJogador * 0.5;
        this.alturaSprite = tamanhoDoJogador * 1.5;
        this.x = x;
        this.peNoChaoY = peNoChaoY;
        this.y = peNoChaoY - this.alturaSprite * 0.85;
        this.vx = 0;
        this.vy = 0;
        this.cor = cor;
        this.noChao = true;
        this.teclaCima = teclaCima.toUpperCase();
        this.teclaEsquerda = teclaEsquerda.toUpperCase();
        this.teclaDireita = teclaDireita.toUpperCase();
        this.direction = 1;
        this.isTiger = cor.toString() === color(255, 100, 100).toString();
      }

      atualizar() {
        this.vy += gravidade;
        this.y += this.vy;

        if (teclas[this.teclaEsquerda]) {
          this.x -= velocidadeDoJogador;
          this.direction = -1;
        }
        if (teclas[this.teclaDireita]) {
          this.x += velocidadeDoJogador;
          this.direction = 1;
        }

        if (this.y + this.alturaSprite * 0.85 >= alturaDoChao) {
          this.y = alturaDoChao - this.alturaSprite * 0.85;
          this.vy = 0;
          this.noChao = true;
        } else {
          this.noChao = false;
        }

        this.x = constrain(this.x, this.raio, width - this.raio);
      }

      mostrar() {
        push();
        translate(this.x, this.y);
        scale(this.direction, 1);
        imageMode(CORNER);

        let spriteWidth = this.raio * 2;
        let spriteHeight = this.alturaSprite;
        let spriteOffsetY = 0;

        // üêÖ Tiger
        if (this.isTiger) {
          if (tigerEmpurrando) {
            spriteOffsetY = 0;
            image(tigerPushSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          } else if (!this.noChao && tigerJumpSprite) {
            spriteOffsetY = 0;
            image(tigerJumpSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          } else if (teclas[this.teclaEsquerda] || teclas[this.teclaDireita]) {
            spriteOffsetY = -10;
            image(tigerWalkRightSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          } else {
            spriteOffsetY = 0;
            image(tigerSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          }
        }
        // üêª Bear
        else {
          spriteHeight = this.alturaSprite * 1.06;
          if (bearEmpurrando) {
            spriteOffsetY = 7;
            image(bearPushSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          } else if (!this.noChao && bearJumpSprite) {
            spriteOffsetY = 7;
            image(bearJumpSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          } else if (teclas[this.teclaEsquerda] || teclas[this.teclaDireita]) {
            spriteHeight = this.alturaSprite * 1.12;
            spriteOffsetY = 12;
            image(bearWalkRightSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          } else {
            spriteOffsetY = 7;
            image(bearSprite, -spriteWidth/2, -spriteOffsetY, spriteWidth, spriteHeight);
          }
        }
        pop();
      }
    }

    /* ==========================
       Classe Bola (CORRIGIDA)
       ========================== */
    class Bola {
      constructor(x) {
        this.x = x;
        this.raio = raioDaBola;
        this.vx = random([-1, 1]) * velocidadeDoJogador * 0.005;
        this.vy = 0;
        this.spriteOffsetY = 8;
        this.y = alturaDoChao - this.raio + this.spriteOffsetY;

        this.grudada = false;
        this.jogadorDono = null;
        this.podeGrudar = true;
      }

      atualizar() {
        if (this.grudada && this.jogadorDono) {
          let centroJogadorY = this.jogadorDono.y + this.jogadorDono.alturaSprite * 0.5;
          this.x = this.jogadorDono.x;
          this.y = centroJogadorY - 30;
          this.vx = 0;
          this.vy = 0;
          return;
        }

        this.vy += gravidade;
        this.x += this.vx;
        this.y += this.vy;

        if (this.y + this.raio > alturaDoChao + this.spriteOffsetY) {
          this.y = alturaDoChao - this.raio + this.spriteOffsetY;
          this.vy *= -0.75;
          this.vx *= 0.9;
        }

        if (this.x - this.raio < 0) {
          this.x = this.raio;
          this.vx *= -0.8;
        }
        if (this.x + this.raio > width) {
          this.x = width - this.raio;
          this.vx *= -0.8;
        }

        if (this.y - this.raio < 0) {
          this.y = this.raio;
          this.vy *= -0.6;
        }
      }

      verificarColisao() {
        if (!this.podeGrudar) return;

        for (let j of jogadores) {
          let centroJogadorY = j.y + j.alturaSprite * 0.5;
          let dx = this.x - j.x;
          let dy = (this.y - this.spriteOffsetY) - centroJogadorY;
          let distancia = dist(j.x, centroJogadorY, this.x, this.y - this.spriteOffsetY);
          let distanciaMinima = this.raio + j.raio * 0.8;

          if (distancia < distanciaMinima) {
            // ‚úÖ S√≥ gruda se o jogador estiver no ch√£o
            if (!this.grudada && j.noChao) {
              this.grudada = true;
              this.jogadorDono = j;
              return; // Sai aqui para n√£o colidir fisicamente
            }

            // ‚ö†Ô∏è Se n√£o grudou (ex: no ar), faz colis√£o f√≠sica
            if (!this.grudada) {
              let nx = dx / distancia;
              let ny = dy / distancia;
              let overlap = distanciaMinima - distancia;

              // Ajusta posi√ß√£o para n√£o penetrar
              this.x += nx * overlap;
              this.y += ny * overlap + this.spriteOffsetY;

              // Reflex√£o do vetor de velocidade
              let dot = this.vx * nx + this.vy * ny;
              this.vx -= 2 * dot * nx;
              this.vy -= 2 * dot * ny;

              // Pequeno impulso para tornar a defesa efetiva
              this.vx *= 1.1;
              this.vy *= 1.1;
            }
          }
        }
      }

      mostrar() {
        if (bolaSprite) {
          push();
          translate(this.x, this.y + this.spriteOffsetY);
          if (!this.grudada) {
            rotate(atan2(this.vy, this.vx));
          }
          imageMode(CENTER);
          image(bolaSprite, 0, 0, this.raio * 2, this.raio * 2);
          pop();
        } else {
          fill(255);
          noStroke();
          ellipse(this.x, this.y + this.spriteOffsetY, this.raio * 2);
        }
      }

      soltar() {
        this.grudada = false;
        this.jogadorDono = null;
        this.podeGrudar = false;
        setTimeout(() => { this.podeGrudar = true; }, 200);
      }
    }

    /* ==========================
       Teclado (com anima√ß√£o de empurr√£o)
       ========================== */
    window.keyPressed = function() {
      if (!jogoIniciado || jogoAcabou) return;
      teclas[key.toUpperCase()] = true;

      const tiger = jogadores[0];
      const bear = jogadores[1];
      const distanciaEntreJogadores = dist(tiger.x, tiger.y, bear.x, bear.y);
      const alcanceEmpurrao = (tiger.raio + bear.raio) * 1.8;

      // üêÖ Tiger aperta J ‚Üí empurra
      if ((key === 'j' || key === 'J') && podeEmpurrarTiger) {
        if (distanciaEntreJogadores < alcanceEmpurrao) {
          bear.x += velocidadeDoJogador * 3.0;

          if (bola.grudada && bola.jogadorDono === bear) {
            bola.soltar();
            bola.vx = tiger.direction * velocidadeDoJogador * 1.0;
            bola.vy = -puloDoJogador * 0.9;
          }

          // ‚úÖ Ativa sprite de empurr√£o do Tiger
          tigerEmpurrando = true;
          tempoEmpurrando = millis() + 300; // mostra por 300ms

          podeEmpurrarTiger = false;
          setTimeout(() => { podeEmpurrarTiger = true; }, 3000);
        }
      }

      // üêª Bear aperta 0 ‚Üí empurra
      if (key === '0' && podeEmpurrarBear) {
        if (distanciaEntreJogadores < alcanceEmpurrao) {
          tiger.x -= velocidadeDoJogador * 3.0;

          if (bola.grudada && bola.jogadorDono === tiger) {
            bola.soltar();
            bola.vx = bear.direction * velocidadeDoJogador * 1.0;
            bola.vy = -puloDoJogador * 0.9;
          }

          // ‚úÖ Ativa sprite de empurr√£o do Bear
          bearEmpurrando = true;
          tempoEmpurrando = millis() + 300; // mostra por 300ms

          podeEmpurrarBear = false;
          setTimeout(() => { podeEmpurrarBear = true; }, 3000);
        }
      }

      // ü¶ò Pulo
      for (let j of jogadores) {
        if (key.toUpperCase() === j.teclaCima && j.noChao) {
          j.vy = -puloDoJogador * 1.1;
          j.noChao = false;

          if (bola.grudada && bola.jogadorDono === j) {
            bola.soltar();
            bola.vx = j.direction * velocidadeDoJogador * 1.6;
            bola.vy = -puloDoJogador * 1.0;
          }
        }
      }
    };

    window.keyReleased = function() {
      if (key) {
        teclas[key.toUpperCase()] = false;
      }
    };

    /* ==========================
       Fun√ß√µes auxiliares
       ========================== */
    function verificarPlacar() {
      if (placar[0] >= 15 || placar[1] >= 15) {
        fimDeJogo();
        return;
      }

      if (bola.grudada) return;

      const aberturaEsqMinX = larguraDaCesta;
      const aberturaEsqMaxX = espessuraDaCesta - larguraDaCesta;
      const aberturaEsqY = alturaDaCesta + espessuraDaCesta - larguraDaCesta;

      const aberturaDirMinX = width - espessuraDaCesta + larguraDaCesta;
      const aberturaDirMaxX = width - larguraDaCesta;
      const aberturaDirY = alturaDaCesta + espessuraDaCesta - larguraDaCesta;

      if (bola.x > aberturaEsqMinX && bola.x < aberturaEsqMaxX && bola.y > alturaDaCesta && bola.y < aberturaEsqY) {
        bolaNaAreaCestaEsq = true;
      }
      if (bolaNaAreaCestaEsq && bola.y > aberturaEsqY) {
        placar[1]++;
        reiniciarJogo();
        bolaNaAreaCestaEsq = false;
      }

      if (bola.x > aberturaDirMinX && bola.x < aberturaDirMaxX && bola.y > alturaDaCesta && bola.y < aberturaDirY) {
        bolaNaAreaCestaDir = true;
      }
      if (bolaNaAreaCestaDir && bola.y > aberturaDirY) {
        placar[0]++;
        reiniciarJogo();
        bolaNaAreaCestaDir = false;
      }
    }

    function fimDeJogo() {
      jogoAcabou = true;
      noLoop();
      const vencedor = placar[0] >= 2 ? 0 : 1;
      const mensagem = vencedor === 0 ? "Quer melzinho, meu felpudinho?" : "Volta pro seu Sucrilhos, gatinho!";
      const imagemVencedor = vencedor === 0 ? "tigre-vencendo.png" : "urso-vencendo.png";

      document.getElementById('mensagemVitoria').textContent = mensagem;
      document.getElementById('vencedorImagem').src = imagemVencedor;
      document.getElementById('telaVitoria').style.display = 'flex';
    }

    function reiniciarJogo() {
      bola = new Bola(width / 2);
      jogadores[0].x = width * 0.1;
      jogadores[0].y = alturaDoChao - jogadores[0].alturaSprite * 0.85;
      jogadores[0].vy = 0;
      jogadores[1].x = width * 0.9;
      jogadores[1].y = alturaDoChao - jogadores[1].alturaSprite * 0.85;
      jogadores[1].vy = 0;
      podeEmpurrarTiger = true;
      podeEmpurrarBear = true;
      tigerEmpurrando = false;
      bearEmpurrando = false;
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      recalcularMedidas();
      reiniciarJogo();
      loop();
    }
  </script>
</body>
</html>